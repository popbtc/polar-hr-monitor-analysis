<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Polar HR Receiver Dashboard</title>
    <style>
        body {
          background: #000;
          color: #0f0;
          font-family: 'Segoe UI', sans-serif;
          display: flex;
          flex-direction: column;
          align-items: center;
          margin: 0;
          height: 100vh;
        }
        h1 {
          margin-top: 1rem;
          color: #0f0;
          font-size: 1.8rem;
        }
        #grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
          width: 90%;
          max-width: 1200px;
          margin-top: 1rem;
        }
        .card {
          border: 2px solid #0f0;
          border-radius: 12px;
          padding: 1rem;
          text-align: center;
          background: rgba(0, 255, 0, 0.05);
          transition: background 0.3s, transform 0.3s;
        }
        .card.active {
          background: rgba(0, 255, 0, 0.15);
          transform: scale(1.03);
        }
        .device {
          font-size: 1.2rem;
          margin-bottom: 0.5rem;
          color: #8f8;
        }
        .hr {
          font-size: 2.8rem;
          font-weight: bold;
          color: #0f0;
        }
        .timestamp {
          font-size: 0.8rem;
          color: #888;
          margin-top: 0.3rem;
        }
    </style>
</head>
<body>
<h1>‚ù§Ô∏è Polar HR Dashboard</h1>
<div id="grid">
    <!-- ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î 8 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ -->
</div>

<script>
    const wsUrl = 'wss://polar-hr-monitor-analysis-1.onrender.com';
    const socket = new WebSocket(wsUrl);

    const devices = {};
    const grid = document.getElementById('grid');

    // ‚úÖ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏ß‡πâ 8 ‡πÉ‡∏ö‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
    for (let i = 1; i <= 8; i++) {
      const div = document.createElement('div');
      div.className = 'card';
      div.id = 'card' + i;
      div.innerHTML = `
        <div class="device" id="device${i}">Device ${i}</div>
        <div class="hr" id="hr${i}">--</div>
        <div class="timestamp" id="time${i}">--</div>
      `;
      grid.appendChild(div);
    }

    socket.onopen = () => {
      console.log('‚úÖ Connected to WebSocket server');
    };

    socket.onmessage = (event) => {
      try {
        const msg = JSON.parse(event.data);
        const hr = msg.hr ?? msg.value;
        const name = msg.deviceName ?? msg.device ?? 'Unknown';

        if (!hr) return;

        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô list
        if (!devices[name]) {
          const available = Object.keys(devices).length + 1;
          if (available > 8) return; // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 8 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
          devices[name] = available;
        }

        const idx = devices[name];
        const hrElem = document.getElementById('hr' + idx);
        const devElem = document.getElementById('device' + idx);
        const timeElem = document.getElementById('time' + idx);
        const cardElem = document.getElementById('card' + idx);

        hrElem.textContent = hr + ' bpm';
        devElem.textContent = name;
        timeElem.textContent = new Date().toLocaleTimeString();
        cardElem.classList.add('active');
      } catch (err) {
        console.error('‚ùå Error parsing message:', err);
      }
    };

    socket.onclose = () => {
      console.warn('üîå WebSocket closed, retrying...');
      setTimeout(() => location.reload(), 5000);
    };

    socket.onerror = (err) => {
      console.error('‚ö†Ô∏è WebSocket error', err);
    };
</script>
</body>
</html>
