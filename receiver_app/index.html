<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Polar HR Receiver</title>
    <style>
        body {
          font-family: sans-serif;
          display: flex;
          flex-direction: column;
          align-items: center;
          background: #000;
          color: #0f0;
          height: 100vh;
          margin: 0;
          padding: 0;
        }
        #hr {
          font-size: 6rem;
          margin-top: 2rem;
        }
        #device {
          font-size: 2rem;
          margin-bottom: 2rem;
        }
        #chart {
          width: 90%;
          height: 300px;
        }
    </style>
</head>
<body>
<div id="device">Waiting for deviceâ€¦</div>
<div id="hr">-- bpm</div>
<canvas id="chart"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // âœ… à¹ƒà¸Šà¹‰ URL à¸‚à¸­à¸‡ WebSocket server à¸ˆà¸£à¸´à¸‡
    const wsUrl = 'wss://polar-hr-monitor-analysis.onrender.com';
    const socket = new WebSocket(wsUrl);

    socket.onopen = () => {
      console.log('âœ… WebSocket connected to', wsUrl);
    };

    socket.onmessage = (event) => {
      try {
        const msg = JSON.parse(event.data);

        // âœ… à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡à¹à¸šà¸šà¸—à¸µà¹ˆ Flutter à¸ªà¹ˆà¸‡ (à¹„à¸¡à¹ˆà¸¡à¸µ type)
        const hr = msg.hr ?? msg.value;
        const device = msg.deviceName ?? msg.device ?? "Unknown device";

        if (hr) {
          document.getElementById('device').textContent = device;
          document.getElementById('hr').textContent = hr + ' bpm';
          addData(hr);
        }
      } catch (err) {
        console.error('âŒ Error parsing message:', err);
      }
    };

    socket.onerror = (err) => {
      console.error('âš ï¸ WebSocket error', err);
    };

    socket.onclose = () => {
      console.warn('ðŸ”Œ WebSocket closed, retrying in 5s...');
      setTimeout(() => location.reload(), 5000);
    };

    // âœ… Chart.js à¸ªà¸³à¸«à¸£à¸±à¸š realtime HR
    const ctx = document.getElementById('chart').getContext('2d');
    const data = {
      labels: [],
      datasets: [{
        label: 'HR (bpm)',
        data: [],
        borderColor: 'lime',
        backgroundColor: 'rgba(0,255,0,0.2)',
        fill: true,
        tension: 0.3
      }]
    };
    const config = {
      type: 'line',
      data: data,
      options: {
        animation: false,
        scales: {
          x: { display: true, title: { text: 'Time', display: true, color: '#0f0' }, ticks: { color: '#0f0' } },
          y: { min: 40, max: 200, title: { text: 'Heart Rate (bpm)', display: true, color: '#0f0' }, ticks: { color: '#0f0' } }
        },
        plugins: {
          legend: { labels: { color: '#0f0' } }
        }
      }
    };
    const chart = new Chart(ctx, config);

    function addData(bpm) {
      const now = new Date().toLocaleTimeString();
      data.labels.push(now);
      data.datasets[0].data.push(bpm);
      if (data.labels.length > 30) {
        data.labels.shift();
        data.datasets[0].data.shift();
      }
      chart.update();
    }
</script>
</body>
</html>
